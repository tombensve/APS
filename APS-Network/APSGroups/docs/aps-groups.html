<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generated-by" content="MarkdownDoc"/>
    <link href="docs.css" type="text/css" rel="stylesheet"/>
  </head>
  <body>
    <H1>APSGroups</H1>
    <p>
      Provides network groups where named groups can be joined as members and then send and receive data messages to the group. This is based on multicast and provides a verified multicast delivery with acknowledgements of receive to the sender and resends if needed. The sender will get an exception if not all members receive all data. Member actuality is handled by members announcing themselves relatively often and will be removed when an announcement does not come in expected time. So if a member dies unexpectedly (network goes down, etc) its membership will resolve rather quickly. Members also tries to inform the group when they are doing a controlled exit.      
    </p>
    <p>
      Please note that this does not support streaming! That would require a far more complex protocol. APSGroups waits in all packets of a message before delivering the message.      
    </p>
    <H2>OSGi service usage</H2>
    <p>
      The APSGroupsService can be used as an OSGi service and as a standalone library. This section describes the service.      
    </p>
    <H3>Getting the service</H3>
    <pre>
      <code>
    APSServiceTracker&lt;APSGroupService&gt; apsGroupsServiceTracker = 
        new APSServiceTracker&lt;APSGroupsService&gt;(bundleContext, APSConfigService.class,
        APSServiceTracker.LARGE_TIMEOUT);
    APSGroupsService apsGroupsService = apsGroupsServiceTracker.getWrappedService();
    
      </code>
    </pre>
    <H3>Joining a group</H3>
    <pre>
      <code>
    GroupMember groupMember = apsGroupsService.joinGroup("mygroup");
    
      </code>
    </pre>
    <H3>Sending a message</H3>
    <p>
      To send a message you create a message, get its output stream and write whatever you want to send on that output stream, close it and then send it. <em>Note</em> that since the content of the message is any data you want, all members of the groups must know how the data sent looks like. In other words, you have to define your own message protocol for your messages. Note that you can wrap the OutputStream in an ObjectOutputStream and serialize any java object you want.      
    </p>
    <pre>
      <code>
    Message message = groupMember.createNewMessage();
    OutputStream msgDataStream = message.getOutputStream();
    try {
        ...
        msgDataStream.close();
        groupMember.sendMessage(message);
    }
    catch (IOException ioe) {
        ...
    }
    
      </code>
    </pre>
    <p>
      Note that the <code>groupMember.sendMessage(message)</code> does throw an IOException on failure to deliver the message to all members.      
    </p>
    <H3>Receiving a message</H3>
    <p>
      To receive a message you have to register a message listener with the GroupMember object.      
    </p>
    <pre>
      <code>
    MessageListener msgListener = new MyMsgListener();
    groupMember.addMessageListener(myMsgListener); 
      </code>
    </pre>
    <p>
      and then handle received messages:      
    </p>
    <pre>
      <code>
    public class MyMsgListener implements MessageListener {
        public void messageReceived(Message message) {
            InputStream msgDataStream = message.getInputStream();
            ...
        }
    }
      </code>
    </pre>
    <H3>Leaving a group</H3>
    <pre>
      <code>
    apsGroupsService.leaveGroup(groupMember);
    
      </code>
    </pre>
    <H2>Library usage</H2>
    <p>
      The bundle jar file can also be used as a library outside of an OSGi server, with an API that has no other dependencies than what is in the jar. The API is then slightly different, and resides under the se.natusoft.apsgroups package.      
    </p>
    <H3>Setting up</H3>
    <pre>
      <code>
    APSGroups apsGroups = new APSGroups(config, logger);
    apsGroups.connect();
    
      </code>
    </pre>
    <p>
      The config passed as argument to APSGroups will be explained further down under "Configuration".      
    </p>
    <p>
      The <em>logger</em> is an instance of an implementation of the APSGroupsLogger interface. Either you provide your own implementation of that or your use the APSGroupsSystemOutLogger implementation.      
    </p>
    <H3>Joining a group</H3>
    <pre>
      <code>
    GroupMember groupMember = apsGroups.joinGroup("mygroup");
      </code>
    </pre>
    <H3>Sending and receiving messages</H3>
    <p>
      Sending and receiving works exactly like the OSGi examples above.      
    </p>
    <H3>Leaving a group</H3>
    <pre>
      <code>
    apsGroups.leaveGroup(groupMember);
      </code>
    </pre>
    <H3>Shutting down</H3>
    <pre>
      <code>
    apsGroups.disconnect();
    
      </code>
    </pre>
    <H2>Net time</H2>
    <p>
      All APSGroups instances connected will try to sync their time. I call this synced time "net time".      
    </p>
    <p>
      It works like this: When an APSGroups instance comes up it waits a while for NET_TIME packets. If it gets such a packet then it enters receive mode and takes the time in the received NET_TIME packet and stores a diff to that time and local time. This diff can then be used to translate back and forth between local and net time. If no such packet arrives in expected time it enters send mode and starts sending NET_TIME packets itself using its current net time. If a NET_TIME packet is received when in send mode it directly goes over to listen mode. If in listen mode and no NET_TIME packet comes in reasonable time it goes over to send mode. So among all instances on the network only one is responsible for sending NET_TIME. If that instance leaves then there might be a short fight for succession, but it will resolve itself rather quickly.      
    </p>
    <p>
      The GroupMember contains a few <em>create*</em> methods to produce a <em>NetTime</em> object instance. See the API further down for more information on these.      
    </p>
    <H2>Configuration</H2>
    <H3>OSGi service </H3>
    <p>
      The OSGi service provides a configuration model that gets managed by the APSConfigService. It can be configured in the APS adminweb (http://host:port/apsadminweb/). Here are some screenshots of the config admin:      
    </p>
    <p>
            <img src='http://download.natusoft.se/Images/APS/APS-Network/APSGroups/docs/images/groups-config-1.png' title='' alt='/apsconfigadmin web gui for configuring APSGroups 1'/>       <img src='http://download.natusoft.se/Images/APS/APS-Network/APSGroups/docs/images/groups-config-2.png' title='' alt='/apsconfigadmin web gui for configuring APSGroups 2'/>       <img src='http://download.natusoft.se/Images/APS/APS-Network/APSGroups/docs/images/groups-config-3.png' title='' alt='/apsconfigadmin web gui for configuring APSGroups 3'/>       <img src='http://download.natusoft.se/Images/APS/APS-Network/APSGroups/docs/images/groups-config-4.png' title='' alt='/apsconfigadmin web gui for configuring APSGroups 4'/>      
    </p>
    <p>
      As can bee seen in the above screenshots transports need to be configured for communication to work. If you only need to talk to members on the same subnet the multicast transport is enough! The multicast transport makes sure that all transmitted data is received by all known group members. It will do resends if required, and throw an exception on failure of any member to acknowledge all sent packets.      
    </p>
    <p>
      If you need to talk to members on a different subnet then you need to use the TCP transports. Note that there are 2 of these: <em>TCP_SENDER</em>, and <em>TCP_RECEIVER</em>. One receiver must be configured and can receive messages from anyone. A sender is needed for each APSGroups installation you want to talk to, and should point to the receiver of that installation. Note that for a receiver you only need to specify a port. The host part is ignored by the receiver.      
    </p>
    <H3>Library </H3>
    <p>
      The library wants an implementation of the APSGroupsConfig interface as its first argument to APSGroups(config, logger) constructor. Either you implement your own or use the APSGroupsConfigProvider implementation. This is a plain java bean with both setters and getters for the config values. It comes with quite reasonable default values. It contains exactly the same properties as shown in the screenshots above.      
    </p>
    <H2>APIs</H2>
    <p>
            
    </p>
    <p>
      <strong>List&lt;String&gt; getGroupNames()</strong>      
    </p>
    <p>
      Returns the names of all available groups.      
    </p>
    <p>
      <strong>List&lt;String&gt; getGroupMembers(String groupName)</strong>      
    </p>
    <p>
      Returns a list of member ids for the specified group.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>groupName</em> - The name of the group to get member ids for.         
      </p>
    </blockquote>
    <p>
      <strong>List&lt;String&gt; getGroupsAndMembers()</strong>      
    </p>
    <p>
      Returns a list of "groupName : groupMember" for all groups and members.      
    </p>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
            
    </p>
    <p>
      <strong>GroupMember joinGroup(String name) throws IOException</strong>      
    </p>
    <p>
      Joins a group.      
    </p>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        A GroupMember that provides the API for sending and receiving data in the group.        
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>name</em> - The name of the group to join.         
      </p>
    </blockquote>
    <p>
      <em>Throws</em>      
    </p>
    <blockquote>
      <p>
        <em>java.io.IOException</em> - The unavoidable one!         
      </p>
    </blockquote>
    <p>
      <strong>GroupMember joinGroup(String name, Properties memberUserData) throws IOException</strong>      
    </p>
    <p>
      Joins a group.      
    </p>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        A GroupMember that provides the API for sending and receiving data in the group.        
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>name</em> - The name of the group to join.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>memberUserData</em> - Data provided by users of the service.         
      </p>
    </blockquote>
    <p>
      <em>Throws</em>      
    </p>
    <blockquote>
      <p>
        <em>java.io.IOException</em> - The unavoidable one!         
      </p>
    </blockquote>
    <p>
      <strong>void leaveGroup(GroupMember groupMember) throws IOException</strong>      
    </p>
    <p>
      Leaves as member of group.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>groupMember</em> - The GroupMember returned when joined.         
      </p>
    </blockquote>
    <p>
      <em>Throws</em>      
    </p>
    <blockquote>
      <p>
        <em>java.io.IOException</em> - The unavoidable one!         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
            
    </p>
    <p>
      <strong>void addMessageListener(MessageListener listener)</strong>      
    </p>
    <p>
      Adds a listener for incoming messages.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>listener</em> - The listener to add.         
      </p>
    </blockquote>
    <p>
      <strong>void removeMessageListener(MessageListener listener)</strong>      
    </p>
    <p>
      Removes a listener for incoming messages.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>listener</em> - The listener to remove.         
      </p>
    </blockquote>
    <p>
      <strong>Message createNewMessage()</strong>      
    </p>
    <p>
      Creates a new Message to send. Use the sendMessage() method when ready to send it.      
    </p>
    <p>
      <strong>void sendMessage(Message message) throws IOException</strong>      
    </p>
    <p>
      Sends a previously created messaging to all current members of the group. If this returns without an exception then all members have received the messaging.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>message</em> - The messaging to send.         
      </p>
    </blockquote>
    <p>
      <em>Throws</em>      
    </p>
    <blockquote>
      <p>
        <em>java.io.IOException</em> - On failure to reach all members.         
      </p>
    </blockquote>
    <p>
      <strong>UUID getMemberId()</strong>      
    </p>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        The ID of the member.        
      </p>
    </blockquote>
    <p>
      <strong>List&lt;String&gt; getMemberInfo()</strong>      
    </p>
    <p>
      Returns information about members.      
    </p>
    <p>
      <strong>List&lt;Properties&gt; getMembersUserProperties()</strong>      
    </p>
    <p>
      Returns the user properties for the members.      
    </p>
    <p>
      <strong>NetTime getNow()</strong>      
    </p>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        The current time as net time.        
      </p>
    </blockquote>
    <p>
      <strong>NetTime createFromNetTime(long netTimeMillis)</strong>      
    </p>
    <p>
      Creates from milliseconds in net time.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>netTimeMillis</em> - The net time milliseconds to create a NetTime for.         
      </p>
    </blockquote>
    <p>
      <strong>NetTime createFromNetTime(Date netTimeDate)</strong>      
    </p>
    <p>
      Creates from a Date in net time.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>netTimeDate</em> - The Date in net time to create a NetTime for.         
      </p>
    </blockquote>
    <p>
      <strong>NetTime createFromLocalTime(long localTimeMillis)</strong>      
    </p>
    <p>
      Creates from milliseconds in local time.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>localTimeMillis</em> - The local time milliseconds to create a NetTime for.         
      </p>
    </blockquote>
    <p>
      <strong>NetTime createFromLocalTime(Date localTimeDate)</strong>      
    </p>
    <p>
      Creates from a Date in local time.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>localTimeDate</em> - The Date in local time to create a NetTime for.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
            
    </p>
    <p>
      <strong>OutputStream getOutputStream()</strong>      
    </p>
    <p>
      Returns an <em>OutputStream</em> to write messaging on. Multiple calls to this will return the same <em>OutputStream</em>!      
    </p>
    <p>
      <strong>InputStream getInputStream()</strong>      
    </p>
    <p>
      Returns an <em>InputStream</em> for reading the messaging. Multiple calls to this will return new <em>InputStream</em>:s starting from the beginning!      
    </p>
    <p>
      <strong>UUID getId()</strong>      
    </p>
    <p>
      Returns the id of this messaging.      
    </p>
    <p>
      <strong>String getMemberId()</strong>      
    </p>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        id of member as a string.        
      </p>
    </blockquote>
    <p>
      <strong>String getGroupName()</strong>      
    </p>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        The name of the group this messaging belongs to.        
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
            
    </p>
    <p>
      <strong>public void messageReceived(Message message)</strong>      
    </p>
    <p>
      Notification of received messaging.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>message</em> - The received messaging.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
            
    </p>
    <p>
      <strong>public long getNetTime()</strong>      
    </p>
    <p>
      Returns the number of milliseconds since January 1, 1970 in net time.      
    </p>
    <p>
      <strong>public Date getNetTimeDate()</strong>      
    </p>
    <p>
      Returns the net time as a Date.      
    </p>
    <p>
      <strong>public Calendar getNetTimeCalendar()</strong>      
    </p>
    <p>
      Returns the net time as a Calendar.      
    </p>
    <p>
      <strong>public Calendar getNetTimeCalendar(Locale locale)</strong>      
    </p>
    <p>
      Returns the net time as a Calendar.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>locale</em> - The locale to use.         
      </p>
    </blockquote>
    <p>
      <strong>public Date getLocalTimeDate()</strong>      
    </p>
    <p>
      Converts the net time to local time and returns as a Date.      
    </p>
    <p>
      <strong>public Calendar getLocalTimeCalendar()</strong>      
    </p>
    <p>
      Converts the net time to local time and returns as a Calendar.      
    </p>
    <p>
      <strong>public Calendar getLocalTimeCalendar(Locale locale)</strong>      
    </p>
    <p>
      Converts the net time to local time and returns as a Calendar.      
    </p>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>locale</em> - The locale to use.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      <strong>/* * * PROJECT *     Name *         APS APIs * *     Code Version *         1.0.0 * *     Description *         Provides the APIs for the application platform services. * * COPYRIGHTS *     Copyright (C) 2012 by Natusoft AB All rights reserved. * * LICENSE *     Apache 2.0 (Open Source) * *     Licensed under the Apache License, Version 2.0 (the "License")</strong>      
    </p>
    <p>
      Use services under messaging instead!      
    </p>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
  </body>
</html>
