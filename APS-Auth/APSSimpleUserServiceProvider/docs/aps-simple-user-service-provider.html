<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generated-by" content="MarkdownDoc"/>
    <link href="docs.css" type="text/css" rel="stylesheet"/>
  </head>
  <body>
    <H1>APSSimpleUserService</H1>
    <p>
      This is an simple, easy to use service for handling logged in users. It provides two services: APSSimpleUserService and APSSimpleUserServiceAdmin. The latter handles all creation, editing, and deletion of roles and users. This service in itself does not require any authentication to use! Thereby you have to trust all code in the server! The APSUserAdminWeb WAB bundle however does require a user with role ’apsadmin’ to be logged in or it will simply repsond with a 401 (UNAUTHORIZED).      
    </p>
    <p>
      So why this and not org.osgi.service.useradmin ? Well, maybe I’m just stupid, but <em>useradmin</em> does not make sense to me. It seems to be missing things, specially for creating. You can create a role, but you cannot create a user. There is no obvious authentication of users. Maybee that should be done via the credentials Dictionary, but what are the expected keys in there ? This service is intended to make user and role handling simple and clear.      
    </p>
    <H2>Basic example</H2>
    <p>
      To login a user do something like this:      
    </p>
    <pre>
      <code>
    APSSimpleUserService userService ...
    ...
    User user = userService.getUser(userId);
    if (user == null) {
        throw new AuthException(”Bad login!”);
    }
    if (!userService.authenticateUser(user, password, APSSimpleUserService.AUTH_METHOD_PASSWORD)) {
        throw new AuthException(”Bad login!”);
    }
    ...
    if (user.isAuthenticated() &amp;&amp; user.hasRole(”apsadmin”)) {
        ...
    }
    
      </code>
    </pre>
    <H2>Setup</H2>
    <p>
      The following SQL is needed to create the database tables used by the service.      
    </p>
    <pre>
      <code>
    /*
     * This represents one role.
     */
    create table role (
      /* The id and key of the role. */
      id varchar(50) not null primary key,
    
      /* A short description of what the role represents. */
      description varchar(200),
    
      /* 1 == master role, 0 == sub-role. */
      master int
    );
    
    /*
     * This represents one user.
     */
    create table svcuser (
      /* User id and also key. */
      id varchar(50) not null primary key,
    
      /* For the provided implementation this is a password. */
      auth varchar(2000),
    
      /*
       * The service stores string properties for the user here as one long string.
       * These are not meant to be searchable only to provide information about the
       * user.
       *
       * You might want to adapt this size to the amount of data you will be adding
       * to a user.
       */
      user_data varchar(4000)
    );
    
    /*
     * A user can have one or more roles.
     */
    create table user_role (
      user_id varchar(50) not null,
      role_id varchar(50) not null,
      primary key (user_id, role_id),
      foreign key (user_id) references svcuser (id),
      foreign key (role_id) references role (id)
    );
    
    /*
     * A role can have one ore more sub-roles.
     */
    create table role_role (
      master_role_id varchar(50) not null,
      role_id varchar(50) not null,
      primary key (master_role_id, role_id),
      foreign key (master_role_id) references role (id),
      foreign key (role_id) references role (id)
    );
    
    /*
     * ---- This part is mostly an example ----
     * WARNING: You do however need a role called 'apsadmin' to be able to login to
     * /apsadminweb! The name of the user having that role does not matter. As long
     * as it is possible to login to /apsadminweb new roles and users can be created
     * there.
     */
    
    /* The following adds an admin user. */
    insert into role VALUES ('apsadmin', 'Default admin for APS', 1);
    insert into svcuser VALUES ('apsadmin', 'admin', '');
    insert into user_role VALUES ('apsadmin', 'apsadmin');
    
    /* This adds a role for non admin users. */
    insert into role VALUES ('user', 'Plain user', 1);
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      </code>
    </pre>
    <!--
      
The above empty lines are required due to a bug in iText used to render the PDF. It will move the picture to the next page completely out of context since text after the picture will then come before it. 
    -->
    <p>
      After the tables have been created you need to configure a datasource for it in /apsadminweb configuration tab:      
    </p>
    <p>
            <img src='http://download.natusoft.se/Images/APS/APS-Auth/APSSimpleUserServiceProvider/docs/images/DataSourceConfig.png' title='' alt='Picture of datasource config gui.'/>      
    </p>
    <p>
      Please note that the above picture is just an example. The data source name <strong>APSSimpleUserServiceDS</strong> is however important. The service will be looking up the entry with that name! The rest of the entry depends on your database and where it is running. Also note that the ”(default)” after the field names in the above picture are the name of the currently selected configuration environment. This configuration is configuration environment specific. You can point out different database servers for different environments for example.      
    </p>
    <H2>APIs</H2>
    <p>
      public <em>interface</em> <strong>APSSimpleUserService </strong>   [se.natusoft.osgi.aps.api.auth.user] {      
    </p>
    <blockquote>
      <p>
         This is the API of a simple user service that provide basic user handling that will probably be enough in many cases, but not all.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        Please note that this API does not declare any exceptions! In the case of an exception being needed the APSSimpleUserServiceException should be thrown. This is a runtime exception.         
      </p>
    </blockquote>
    <p>
      <strong>public static final String AUTH_METHOD_PASSWORD = "password"</strong>      
    </p>
    <blockquote>
      <p>
         Password authentication method for authenticateUser().         
      </p>
    </blockquote>
    <p>
      <strong>public Role getRole(String roleId)</strong>      
    </p>
    <blockquote>
      <p>
         Gets a role by its id.          
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        A Role object representing the role or null if role was not found.        
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>roleId</em> - The id of the role to get.         
      </p>
    </blockquote>
    <p>
      <strong>public User getUser(String userId)</strong>      
    </p>
    <blockquote>
      <p>
         Gets a user by its id.          
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        A User object representing the user or null if userId was not found.        
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>userId</em> - The id of the user to get.         
      </p>
    </blockquote>
    <p>
      <strong>public boolean authenticateUser(User user, Object authentication, String authMethod)</strong>      
    </p>
    <blockquote>
      <p>
         Authenticates a user using its user id and user provided authentication.          
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        true if authenticated, false otherwise. If true user.isAuthenticated() will also return true.        
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>user</em> - The User object representing the user to authenticate.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>authentication</em> - The user provided authentication data. For example if AuthMethod is AUTH_METHOD_PASSWORD         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>authMethod</em> - Specifies what authentication method is wanted.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      public <em>interface</em> <strong>APSSimpleUserServiceAdmin </strong> extends  APSSimpleUserService    [se.natusoft.osgi.aps.api.auth.user] {      
    </p>
    <blockquote>
      <p>
         Admin API for APSSimpleUserService.         
      </p>
    </blockquote>
    <p>
      <strong>public RoleAdmin createRole(String name, String description)</strong>      
    </p>
    <blockquote>
      <p>
         Creates a new role.          
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        a new Role object representing the role.        
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>name</em> - The name of the role. This is also the key and cannot be changed.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>description</em> - A description of the role. This can be updated afterwards.         
      </p>
    </blockquote>
    <p>
      <strong>public void updateRole(Role role)</strong>      
    </p>
    <blockquote>
      <p>
         Updates a role.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>role</em> - The role to update.         
      </p>
    </blockquote>
    <p>
      <strong>public void deleteRole(Role role)</strong>      
    </p>
    <blockquote>
      <p>
         Deletes a role.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>role</em> - The role to delete. This will likely fail if there are users still having this role!         
      </p>
    </blockquote>
    <p>
      <strong>public List&lt;RoleAdmin&gt; getRoles()</strong>      
    </p>
    <blockquote>
      <p>
         Returns all available roles.         
      </p>
    </blockquote>
    <p>
      <strong>public UserAdmin createUser(String id)</strong>      
    </p>
    <blockquote>
      <p>
         Creates a new user. Please note that you get an empty user back. You probably want to add roles and also possibly properties to the user. After you have done that call updateUser(user).          
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        A User object representing the new user.        
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>id</em> - The id of the user. This is key so it must be unique.         
      </p>
    </blockquote>
    <p>
      <strong>public void updateUser(User user)</strong>      
    </p>
    <blockquote>
      <p>
         Updates a user.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>user</em> - The user to update.         
      </p>
    </blockquote>
    <p>
      <strong>public void deleteUser(User user)</strong>      
    </p>
    <blockquote>
      <p>
         Deletes a user.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>user</em> - The user to delete.         
      </p>
    </blockquote>
    <p>
      <strong>public List&lt;UserAdmin&gt; getUsers()</strong>      
    </p>
    <blockquote>
      <p>
         Returns all users.         
      </p>
    </blockquote>
    <p>
      <strong>public void setUserAuthentication(User user, String authentication)</strong>      
    </p>
    <blockquote>
      <p>
         Sets authentication for the user.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>user</em> - The user to set authentication for.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>authentication</em> - The authentication to set.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      public <em>class</em> <strong>APSAuthMethodNotSupportedException </strong> extends  APSRuntimeException    [se.natusoft.osgi.aps.api.auth.user.exceptions] {      
    </p>
    <blockquote>
      <p>
         This is thrown by APSAuthService when the implementation does not support the selected auth method.         
      </p>
    </blockquote>
    <p>
      <strong>public APSAuthMethodNotSupportedException(String message)</strong>      
    </p>
    <blockquote>
      <p>
         Creates a new APSAuthMethodNotSupportedException instance.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>message</em> - The exception message.         
      </p>
    </blockquote>
    <p>
      <strong>public APSAuthMethodNotSupportedException(String message, Throwable cause)</strong>      
    </p>
    <blockquote>
      <p>
         Creates a new APSAuthMethodNotSupportedException instance.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>message</em> - The exception message.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>cause</em> - The exception that is the cause of this one.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      public <em>class</em> <strong>APSSimpleUserServiceException </strong> extends  APSRuntimeException    [se.natusoft.osgi.aps.api.auth.user.exceptions] {      
    </p>
    <blockquote>
      <p>
         Indicates a problem with the APSSimpleUserService.         
      </p>
    </blockquote>
    <p>
      <strong>public APSSimpleUserServiceException(String message)</strong>      
    </p>
    <blockquote>
      <p>
         Creates a new APSSimpleUserServiceException instance.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>message</em> - The exception message.         
      </p>
    </blockquote>
    <p>
      <strong>public APSSimpleUserServiceException(String message, Throwable cause)</strong>      
    </p>
    <blockquote>
      <p>
         Creates a new APSSimpleUserServiceException instance.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>message</em> - The exception message.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>cause</em> - The cause of the exception.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      public <em>interface</em> <strong>Role </strong> extends  Comparable&lt;Role&gt;    [se.natusoft.osgi.aps.api.auth.user.model] {      
    </p>
    <blockquote>
      <p>
         This defines a role.         
      </p>
    </blockquote>
    <p>
      <strong>public String getId()</strong>      
    </p>
    <blockquote>
      <p>
                 
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        The id of the role.        
      </p>
    </blockquote>
    <p>
      <strong>public String getDescription()</strong>      
    </p>
    <blockquote>
      <p>
                 
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        A description of the role.        
      </p>
    </blockquote>
    <p>
      <strong>public boolean hasRole(String roleName)</strong>      
    </p>
    <blockquote>
      <p>
         Returns true if the role has the specified sub role name.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>roleName</em> - The name of the role to check for.         
      </p>
    </blockquote>
    <p>
      <strong>boolean isMasterRole()</strong>      
    </p>
    <blockquote>
      <p>
                 
      </p>
    </blockquote>
    <p>
      <em>Returns</em>      
    </p>
    <blockquote>
      <p>
        true if this role is a master role. Only master roles can be added to users.        
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      public <em>interface</em> <strong>RoleAdmin </strong> extends  Role    [se.natusoft.osgi.aps.api.auth.user.model] {      
    </p>
    <blockquote>
      <p>
         Provides update API for Role.         
      </p>
    </blockquote>
    <p>
      <strong>public void setDescription(String description)</strong>      
    </p>
    <blockquote>
      <p>
         Changes the description of the role.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>description</em> - The new description.         
      </p>
    </blockquote>
    <p>
      <strong>public List&lt;Role&gt; getRoles()</strong>      
    </p>
    <blockquote>
      <p>
         Returns all sub roles for this role.         
      </p>
    </blockquote>
    <p>
      <strong>public void addRole(Role role)</strong>      
    </p>
    <blockquote>
      <p>
         Adds a sub role to this role.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>role</em> - The role to add.         
      </p>
    </blockquote>
    <p>
      <strong>public void removeRole(Role role)</strong>      
    </p>
    <blockquote>
      <p>
         Removes a sub role from this role.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>role</em> - The role to remove.         
      </p>
    </blockquote>
    <p>
      <strong>public void setMasterRole(boolean masterRole)</strong>      
    </p>
    <blockquote>
      <p>
         Sets whether this is a master role or not.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>masterRole</em> - true for master role.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      public <em>interface</em> <strong>User </strong> extends  Comparable&lt;User&gt;    [se.natusoft.osgi.aps.api.auth.user.model] {      
    </p>
    <blockquote>
      <p>
         This defines a User.         
      </p>
    </blockquote>
    <p>
      <strong>public String getId()</strong>      
    </p>
    <blockquote>
      <p>
         Returns the unique id of the user.         
      </p>
    </blockquote>
    <p>
      <strong>public boolean isAuthenticated()</strong>      
    </p>
    <blockquote>
      <p>
         Returns true if this user is authenticated.         
      </p>
    </blockquote>
    <p>
      <strong>public boolean hasRole(String roleName)</strong>      
    </p>
    <blockquote>
      <p>
         Returns true if the user has the specified role name.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>roleName</em> - The name of the role to check for.         
      </p>
    </blockquote>
    <p>
      <strong>public Properties getUserProperties()</strong>      
    </p>
    <blockquote>
      <p>
         This provides whatever extra information about the user you want. How to use this is upp to the user of the service. There are some constants in this class that provide potential keys for the user properties.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        Please note that the returned properties are read only!         
      </p>
    </blockquote>
    <p>
      <strong>public static final String USER_NAME = "name"</strong>      
    </p>
    <blockquote>
      <p>
         Optional suggestion for user properties key.         
      </p>
    </blockquote>
    <p>
      <strong>public static final String USER_PHONE = "phone"</strong>      
    </p>
    <blockquote>
      <p>
         Optional suggestion for user properties key.         
      </p>
    </blockquote>
    <p>
      <strong>public static final String USER_PHONE_WORK = "phone.work"</strong>      
    </p>
    <blockquote>
      <p>
         Optional suggestion for user properties key.         
      </p>
    </blockquote>
    <p>
      <strong>public static final String USER_PHONE_HOME = "phone.home"</strong>      
    </p>
    <blockquote>
      <p>
         Optional suggestion for user properties key.         
      </p>
    </blockquote>
    <p>
      <strong>public static final String USER_EMAIL = "email"</strong>      
    </p>
    <blockquote>
      <p>
         Optional suggestion for user properties key.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
    <p>
      public <em>interface</em> <strong>UserAdmin </strong> extends  User    [se.natusoft.osgi.aps.api.auth.user.model] {      
    </p>
    <blockquote>
      <p>
         Provides update API for the User.         
      </p>
    </blockquote>
    <p>
      <strong>public List&lt;Role&gt; getRoles()</strong>      
    </p>
    <blockquote>
      <p>
         Returns all roles for this user.         
      </p>
    </blockquote>
    <p>
      <strong>public void addRole(Role role)</strong>      
    </p>
    <blockquote>
      <p>
         Adds a role to this user.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>role</em> - The role to add.         
      </p>
    </blockquote>
    <p>
      <strong>public void removeRole(Role role)</strong>      
    </p>
    <blockquote>
      <p>
         Removes a role from this user.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>role</em> - The role to remove.         
      </p>
    </blockquote>
    <p>
      <strong>public void addUserProperty(String key, String value)</strong>      
    </p>
    <blockquote>
      <p>
         Adds a user property.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>key</em> - The key of the property.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        <em>value</em> - The value of the property.         
      </p>
    </blockquote>
    <p>
      <strong>public void removeUserProperty(String key)</strong>      
    </p>
    <blockquote>
      <p>
         Removes a user property.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>key</em> - The key of the property to remove.         
      </p>
    </blockquote>
    <p>
      <strong>public void setUserProperties(Properties properties)</strong>      
    </p>
    <blockquote>
      <p>
         Sets properties for the user.         
      </p>
    </blockquote>
    <blockquote>
      <p>
        To update the user properties either first do getProperties() do your changes, and then call this method with the changed properties or just use the addUserProperty() and removeUserProperty() methods.          
      </p>
    </blockquote>
    <p>
      <em>Parameters</em>      
    </p>
    <blockquote>
      <p>
        <em>properties</em> - The properties to set.         
      </p>
    </blockquote>
    <p>
      }      
    </p>
    <hr/>    <p>
                
    </p>
  </body>
</html>
